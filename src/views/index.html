<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lamax - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="auth.css">
</head>
<body>
<div class="logo">üí¨</div>
<h1>Lamax</h1>
<p class="subtitle">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å —Å–∏—Å—Ç–µ–º–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –û–±—â–∞–π—Ç–µ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –¥—Ä—É–∑—å—è–º–∏ –∏ –∫–æ–ª–ª–µ–≥–∞–º–∏</p>

<div class="status">
    <div class="status-dot"></div>
    <span>–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É <span id="serverPort" class="stats-number">3000</span></span>
</div>

<div class="auth-container">
    <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchTab('login')">–í—Ö–æ–¥</div>
        <div class="auth-tab" onclick="switchTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
    </div>

    <form id="loginForm" class="auth-form active">
        <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
            <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="btn">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
        <div id="loginError" class="error-message"></div>
        <div id="loginSuccess" class="success-message"></div>
    </form>

    <form id="registerForm" class="auth-form">
        <div class="form-group">
            <label for="registerEmail">Email</label>
            <input type="email" id="registerEmail" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
            <label for="registerUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="registerUsername" placeholder="–í–∞—à–µ –∏–º—è" required>
        </div>
        <div class="form-group">
            <label for="registerPassword">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <div class="form-group">
            <label for="registerConfirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="registerConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <div id="registerError" class="error-message"></div>
        <div id="registerSuccess" class="success-message"></div>
    </form>
</div>

<div class="info">
    <h3>üì° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ:</h3>
    <p><strong>–ê–¥—Ä–µ—Å:</strong> <span id="serverAddress" class="stats-number">193.233.86.5:3000</span></p>
    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: #57F287; animation: blink 2s infinite;">‚óè –û–Ω–ª–∞–π–Ω</span></p>
    <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong> <span id="userCount" class="stats-number">0</span></p>
    <p><strong>–û–Ω–ª–∞–π–Ω:</strong> <span id="onlineCount" class="stats-number">0</span></p>
</div>

<script>
    let currentTab = 'login';

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

        document.querySelector('.auth-tabs').className = `auth-tabs ${tab}`;
        document.querySelector('.auth-tab[onclick*="' + tab + '"]').classList.add('active');
        document.getElementById(tab + 'Form').classList.add('active');

        document.getElementById(tab + 'Error').style.display = 'none';
        document.getElementById(tab + 'Success').style.display = 'none';
    }

    function animateStat(element, newValue) {
        if (element.textContent !== newValue) {
            element.classList.add('updated');
            element.textContent = newValue;
            setTimeout(() => {
                element.classList.remove('updated');
            }, 500);
        }
    }

    async function updateStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            animateStat(document.getElementById('userCount'), data.total_users);
            animateStat(document.getElementById('onlineCount'), data.online_users || 0);

            const infoResponse = await fetch('/api/info');
            const infoData = await infoResponse.json();
            if (infoData.server_url) {
                const url = new URL(infoData.server_url);
                animateStat(document.getElementById('serverAddress'), url.host);
                animateStat(document.getElementById('serverPort'), url.port || 80);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        const successDiv = document.getElementById('loginSuccess');

        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (data.success) {
                successDiv.textContent = '‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!';
                successDiv.style.display = 'block';

                // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
                document.querySelector('.btn').style.background = 'var(--secondary)';
                setTimeout(() => {
                    document.querySelector('.btn').style.background = 'var(--primary)';
                }, 1000);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                localStorage.setItem('lamax_session', JSON.stringify({
                    sessionId: data.sessionId,
                    user: data.user
                }));

                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä
                setTimeout(() => {
                    window.location.href = '/app';
                }, 1000);
            } else {
                errorDiv.textContent = '‚ùå ' + data.message;
                errorDiv.style.display = 'block';

                // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                const btn = document.querySelector('.btn');
                btn.style.animation = 'none';
                setTimeout(() => {
                    btn.style.animation = 'pulse 0.5s ease';
                }, 10);
            }
        } catch (error) {
            errorDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
            errorDiv.style.display = 'block';
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('registerEmail').value;
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('registerConfirmPassword').value;
        const errorDiv = document.getElementById('registerError');
        const successDiv = document.getElementById('registerSuccess');

        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π
        if (password !== confirmPassword) {
            errorDiv.textContent = '‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
            errorDiv.style.display = 'block';
            return;
        }

        if (password.length < 6) {
            errorDiv.textContent = '‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
            errorDiv.style.display = 'block';
            return;
        }

        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, username, password })
            });

            const data = await response.json();

            if (data.success) {
                successDiv.textContent = '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥...';
                successDiv.style.display = 'block';

                // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
                document.querySelector('.btn').style.background = 'var(--secondary)';
                setTimeout(() => {
                    document.querySelector('.btn').style.background = 'var(--primary)';
                }, 1000);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                localStorage.setItem('lamax_session', JSON.stringify({
                    sessionId: data.sessionId,
                    user: data.user
                }));

                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä
                setTimeout(() => {
                    window.location.href = '/app';
                }, 1500);
            } else {
                errorDiv.textContent = '‚ùå ' + data.message;
                errorDiv.style.display = 'block';

                // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                const btn = document.querySelector('.btn');
                btn.style.animation = 'none';
                setTimeout(() => {
                    btn.style.animation = 'pulse 0.5s ease';
                }, 10);
            }
        } catch (error) {
            errorDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
            errorDiv.style.display = 'block';
        }
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é
    function checkExistingSession() {
        const sessionData = localStorage.getItem('lamax_session');
        if (sessionData) {
            try {
                const session = JSON.parse(sessionData);
                fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: session.sessionId })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.valid) {
                            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
                            document.body.style.animation = 'fadeIn 0.5s ease reverse';
                            setTimeout(() => {
                                window.location.href = '/app';
                            }, 500);
                        } else {
                            localStorage.removeItem('lamax_session');
                        }
                    });
            } catch (error) {
                localStorage.removeItem('lamax_session');
            }
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats();
    setInterval(updateStats, 10000);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    checkExistingSession();

    // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('focus', () => {
            input.parentElement.style.transform = 'translateY(-2px)';
        });
        input.addEventListener('blur', () => {
            input.parentElement.style.transform = 'translateY(0)';
        });
    })

    // –ê–Ω–∏–º–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞
    document.querySelector('.logo').addEventListener('mouseenter', function() {
        this.style.transform = 'rotate(10deg) scale(1.1)';
    });

    document.querySelector('.logo').addEventListener('mouseleave', function() {
        this.style.transform = 'rotate(0) scale(1)';
    });
</script>
</body>
</html>